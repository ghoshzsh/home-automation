esphome:
  name: water-tank
  friendly_name: Water Tank

esp8266:
  board: esp01_1m

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "Automatically Generated by ESPHome while setting up for first time"

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

sensor:
  # Wifi signal sensor.
  - platform: wifi_signal
    name: water_tank_wifi
    update_interval: 600s
    unit_of_measurement: '%'
    filters:
      - lambda: |-
          if (x <= -100) {
            return 0;
          } else {
            if (x >= -50) {
              return 100;
            } else {
              return 2 * (x + 100);
            }
          }

  # The actual distance sensor
  # Height of tank 122.5 cm -> 122cm round off
  # Perimeter of tank 350 cm -> 55.70 cm radius -> 11.40 diameter -> 9748.24 (cm)2
  # When tank is empty 1.10 m -> When tank is full .20 m
  # On average 1 min will change 6% while motor running. So, 93% can be trigger point as senor is running in every 30 sec.
  - platform: ultrasonic
    trigger_pin: GPIO5
    echo_pin: GPIO4
    name: "Water Level"
    update_interval: 15s
    pulse_time: 10us
    timeout: 2.0m
    accuracy_decimals: 2
    filters:
      - filter_out: nan
      - median:
          window_size: 7
          send_every: 4
          send_first_at: 3
    on_value:
      then:
        - lambda: |-
            // Constants (meters and liters)
            const float distance = x;               // measured distance (m)
            const float dist_empty = 1.10f;         // sensor->water when tank empty (m)
            const float dist_full = 0.10f;          // sensor->water when tank full (m)
            const float usable_height = dist_empty - dist_full; // 0.90 m
            const float liters_per_meter = 974.824f; // area * 1000 -> L per meter

            // compute height of water (m) clamped to [0, usable_height]
            float height = dist_empty - distance;   // how much of usable height is filled
            if (height < 0.0f) height = 0.0f;
            if (height > usable_height) height = usable_height;

            // compute liters and percent
            float liters = height * liters_per_meter;
            float percent = (height / usable_height) * 100.0f;

            // publish to template sensors
            id(watertank_liter).publish_state(liters);
            id(watertank_percent).publish_state(percent);

  - platform: template
    name: 'Water Volume'
    id: watertank_liter
    icon: 'mdi:water'
    unit_of_measurement: 'L'
    accuracy_decimals: 2
    update_interval: 15s

  - platform: template
    name: "Water Percent"
    id: watertank_percent
    icon: 'mdi:water-percent'
    unit_of_measurement: '%'
    accuracy_decimals: 2
    update_interval: 15s

  # DS18B20 sensor
  - platform: dallas_temp
    address: 0x163ce10457368928 #You have to find the address first
    name: "Water Temperature"
    accuracy_decimals: 2

one_wire:
  - platform: gpio
    pin: GPIO12 #D6

binary_sensor:
  - platform: gpio
    name: "Float Raw"
    id: float_raw
    pin:
      number: GPIO14
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on: 100ms
      - delayed_off: 200ms

  - platform: template
    name: "Float Switch (FS37A)"
    lambda: |-
      return !id(float_raw).state;  //software invert
