esphome:
  name: dinning-info
  friendly_name: Dining Info

esp8266:
  board: esp01_1m

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "Automatically Generated by ESPHome while setting up for first time"

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  min_auth_mode: WPA2


sensor:
  # Wifi signal sensor.
  - platform: wifi_signal
    name: WIFI_Signal
    update_interval: 600s
    unit_of_measurement: '%'
    filters:
      - lambda: |-
          if (x <= -100) {
            return 0;
          } else if (x >= -50) {
            return 100;
          } else {
            return 2 * (x + 100);
          }

  - platform: dht
    model: DHT11
    pin: GPIO4
    temperature:
      name: "Temperature"
    humidity:
      name: "Humidity"
    update_interval: 60s

  - platform: homeassistant
    id: watertank_percent_ha
    entity_id: sensor.water_tank_water_percent   # change if your actual entity_id is different

display:
  - platform: tm1637
    id: tank_display
    clk_pin: GPIO5       # TM1637 CLK - D1
    dio_pin: GPIO12      # TM1637 DIO - D6
    length: 4            # 4-digit display
    update_interval: 5s
    intensity: 7
    lambda: |-
      // If the HA sensor has no state yet, show dashes
      if (!id(watertank_percent_ha).has_state()) {
        it.print("----");
        return;
      }

      // Read water percentage from Home Assistant
      // Go to Settings->Devices & Services->Entities to get the entity name
      float pct = id(watertank_percent_ha).state;

      // Clamp between 0 and 100
      if (pct < 0.0f) pct = 0.0f;
      if (pct > 100.0f) pct = 100.0f;

      // Show as integer percent, right-aligned in 3 digits
      // e.g.  5 -> "  5", 75 -> " 75", 100 -> "100"
      it.printf("%3.0f", pct);

output:
  - platform: esp8266_pwm
    pin: GPIO15
    id: rtttl_out

rtttl:
  output: rtttl_out
  gain: 95%
  on_finished_playback:
    - logger.log: 'Stopped Speaker!'

switch:
  - platform: template
    name: 'Buzzer Alert'
    icon: "mdi:bullhorn-outline"
    id: buzzer_on_switch
    turn_on_action:
    - while:
          condition:
            - lambda: "return true;"
          then:
            - rtttl.play: 'siren:d=8,o=5,b=100:d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e'
            - delay: 5s # add delay here, the old rtttl.play should end before the new starts
    turn_off_action:
    - rtttl.stop

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO13
      mode:
        input: true
        pullup: true

    name: "Buzzer Switch"
    on_press:
      then:
        - switch.turn_off: buzzer_on_switch
        - rtttl.stop
